<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export Test Archives to PDF</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 2rem;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 1rem 0;
      color: #1a1a1a;
    }
    .description {
      color: #666;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    .archive-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .archive-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: #f8f8f8;
      border-radius: 6px;
      border: 1px solid #e5e5e5;
    }
    .archive-name {
      font-weight: 500;
      color: #1a1a1a;
    }
    .btn {
      padding: 0.5rem 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #0056b3;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn.success {
      background: #28a745;
    }
    .btn.loading {
      background: #ffc107;
      color: #000;
    }
    .status {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.25rem;
    }
    .log {
      margin-top: 2rem;
      padding: 1rem;
      background: #f8f8f8;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      padding: 0.25rem 0;
      color: #333;
    }
    .log-entry.error {
      color: #dc3545;
    }
    .log-entry.success {
      color: #28a745;
    }
    #cesdk_container {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Export Test Archives to PDF</h1>
    <p class="description">
      This page loads CE.SDK archives and exports them as RGB PDFs for testing.
      Click "Export" next to each archive to download the PDF.
    </p>

    <div class="archive-list">
      <div class="archive-item" data-archive="test-minimal.zip">
        <div>
          <div class="archive-name">test-minimal.zip</div>
          <div class="status"></div>
        </div>
        <button class="btn" onclick="exportArchive('test-minimal.zip', this)">Export</button>
      </div>
      <div class="archive-item" data-archive="test-vectors.zip">
        <div>
          <div class="archive-name">test-vectors.zip</div>
          <div class="status"></div>
        </div>
        <button class="btn" onclick="exportArchive('test-vectors.zip', this)">Export</button>
      </div>
      <div class="archive-item" data-archive="test-text.zip">
        <div>
          <div class="archive-name">test-text.zip</div>
          <div class="status"></div>
        </div>
        <button class="btn" onclick="exportArchive('test-text.zip', this)">Export</button>
      </div>
      <div class="archive-item" data-archive="test-images.zip">
        <div>
          <div class="archive-name">test-images.zip</div>
          <div class="status"></div>
        </div>
        <button class="btn" onclick="exportArchive('test-images.zip', this)">Export</button>
      </div>
      <div class="archive-item" data-archive="test-complex.zip">
        <div>
          <div class="archive-name">test-complex.zip</div>
          <div class="status"></div>
        </div>
        <button class="btn" onclick="exportArchive('test-complex.zip', this)">Export</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <div id="cesdk_container"></div>

  <script type="module">
    import CreativeEditorSDK from 'https://cdn.img.ly/packages/imgly/cesdk-js/1.59.0/index.js';

    const LICENSE_KEY = '%CESDK_LICENSE%';
    let cesdk = null;
    const logEl = document.getElementById('log');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatus(archiveName, message) {
      const item = document.querySelector(`[data-archive="${archiveName}"]`);
      const statusEl = item.querySelector('.status');
      statusEl.textContent = message;
    }

    async function initCESDK() {
      if (cesdk) return cesdk;

      log('Initializing CE.SDK...');
      cesdk = await CreativeEditorSDK.create('#cesdk_container', {
        license: LICENSE_KEY,
        baseURL: 'https://cdn.img.ly/packages/imgly/cesdk-js/1.59.0/assets'
      });
      await cesdk.createDesignScene();
      log('CE.SDK initialized', 'success');
      return cesdk;
    }

    window.exportArchive = async function(archiveName, button) {
      const statusEl = button.parentElement.parentElement.querySelector('.status');

      try {
        button.disabled = true;
        button.className = 'btn loading';
        button.textContent = 'Loading...';
        updateStatus(archiveName, 'Loading...');
        log(`Starting export of ${archiveName}`);

        // Initialize CE.SDK if needed
        await initCESDK();

        // Load archive
        updateStatus(archiveName, 'Loading archive...');
        log(`Loading archive: ${archiveName}`);

        // Use absolute URL for CE.SDK
        const archiveUrl = `${window.location.origin}/fixtures/archives/${archiveName}`;
        log(`Archive URL: ${archiveUrl}`);

        await cesdk.engine.scene.loadFromArchiveURL(archiveUrl);

        // Export as PDF
        updateStatus(archiveName, 'Exporting PDF...');
        log(`Exporting PDF from ${archiveName}`);
        const sceneId = cesdk.engine.scene.get();
        const pdfBlob = await cesdk.engine.block.export(sceneId, 'application/pdf');

        // Download PDF
        const url = URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = archiveName.replace('.zip', '.pdf');
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // Update UI
        button.className = 'btn success';
        button.textContent = '✓ Exported';
        updateStatus(archiveName, `Downloaded as ${archiveName.replace('.zip', '.pdf')}`);
        log(`✓ Successfully exported ${archiveName}`, 'success');

        // Re-enable after delay
        setTimeout(() => {
          button.disabled = false;
          button.className = 'btn';
          button.textContent = 'Export';
        }, 2000);

      } catch (error) {
        console.error('Export failed:', error);
        log(`✗ Failed to export ${archiveName}: ${error.message}`, 'error');
        updateStatus(archiveName, `Error: ${error.message}`);
        button.disabled = false;
        button.className = 'btn';
        button.textContent = 'Export';
      }
    };

    // Initialize on load
    log('Page loaded. Click "Export" to export each archive.');

    // Auto-initialize CE.SDK for automated testing
    if (window.location.search.includes('autoInit=true')) {
      log('Auto-initializing CE.SDK...');
      initCESDK().catch(error => {
        log(`Failed to initialize: ${error.message}`, 'error');
      });
    }
  </script>
</body>
</html>